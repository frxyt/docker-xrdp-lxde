#!/bin/bash

# Copyright (c) 2019 FEROX YT EIRL, www.ferox.yt <devops@ferox.yt>
# Copyright (c) 2019 Jérémy WALTHER <jeremy.walther@golflima.net>
# See <https://github.com/frxyt/docker-xrdp-lxde> for details.

# Create user if it doesn't exist
if [[ ! -d "/home/${FRX_XRDP_USER_NAME}" ]]; then
    echo -n "Creating user '${FRX_XRDP_USER_NAME}' ... "
    # Create user
    /usr/sbin/groupadd -g ${FRX_XRDP_USER_GID} ${FRX_XRDP_USER_NAME}
    /usr/sbin/useradd -g ${FRX_XRDP_USER_GID} -ms /bin/bash -u ${FRX_XRDP_USER_UID} ${FRX_XRDP_USER_NAME}
    # Set password
    echo ${FRX_XRDP_USER_NAME}:${FRX_XRDP_USER_PASSWORD} | /usr/sbin/chpasswd
    # Add user to sudo if needed
    [[ "${FRX_XRDP_USER_SUDO}" == '1' ]] && /usr/sbin/adduser ${FRX_XRDP_USER_NAME} sudo > /dev/null
    # Copy default desktop icons
    mkdir -p /home/${FRX_XRDP_USER_NAME}/Desktop
    cp /usr/share/applications/*.desktop /home/${FRX_XRDP_USER_NAME}/Desktop
    chown ${FRX_XRDP_USER_UID}:${FRX_XRDP_USER_GID} -R /home/${FRX_XRDP_USER_NAME}/Desktop
    echo "[OK]"
fi

# Clear user ENV variables
unset FRX_XRDP_USER_NAME FRX_XRDP_USER_PASSWORD FRX_XRDP_USER_SUDO FRX_XRDP_USER_GID FRX_XRDP_USER_UID

# Adjust TimeZone
echo "Setting time zone to: '${TZ}' ..."
ln -snf "/usr/share/zoneinfo/${TZ}" /etc/localtime
echo "${TZ}" > /etc/timezone
dpkg-reconfigure -f noninteractive tzdata

# Generate server keys
[[ ! -e /etc/xrdp/rsakeys.ini ]] \
    && echo "Generating XRDP RSA keys ..." \
    && xrdp-keygen xrdp /etc/xrdp/rsakeys.ini \
    && chown xrdp:xrdp /etc/xrdp/rsakeys.ini \
    && chmod 400 /etc/xrdp/rsakeys.ini
[[ ! -e /etc/xrdp/cert.pem || ! -e /etc/xrdp/key.pem ]] \
    && echo "Generating XRDP RSA certificate ..." \
    && openssl req -x509 -newkey rsa:4096 -nodes -keyout /etc/xrdp/key.pem -out /etc/xrdp/cert.pem -days 3650 -subj "${FRX_XRDP_CERT_SUBJ}" \
    && chown xrdp:xrdp /etc/xrdp/cert.pem /etc/xrdp/key.pem \
    && chmod 400 /etc/xrdp/cert.pem /etc/xrdp/key.pem
[[ ! -e /etc/ssh/ssh_host_ecdsa_key || ! -e /etc/ssh/ssh_host_ecdsa_key.pub ]] \
    && echo "Generating SSH host ECDSA key ..." \
    && ssh-keygen -t ecdsa -f /etc/ssh/ssh_host_ecdsa_key < /dev/null \
    && chmod 400 /etc/ssh/ssh_host_ecdsa_key && chmod 444 /etc/ssh/ssh_host_ecdsa_key.pub
[[ ! -e /etc/ssh/ssh_host_ed25519_key || ! -e /etc/ssh/ssh_host_ed25519_key.pub ]] \
    && echo "Generating SSH host ED25519 key ..." \
    && ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key < /dev/null \
    && chmod 400 /etc/ssh/ssh_host_ed25519_key && chmod 444 /etc/ssh/ssh_host_ed25519_key.pub
[[ ! -e /etc/ssh/ssh_host_rsa_key || ! -e /etc/ssh/ssh_host_rsa_key.pub ]] \
    && echo "Generating SSH host RSA key ..." \
    && ssh-keygen -t rsa -b 4096 -f /etc/ssh/ssh_host_rsa_key < /dev/null \
    && chmod 400 /etc/ssh/ssh_host_rsa_key && chmod 444 /etc/ssh/ssh_host_rsa_key.pub

# Start supervisor
/usr/bin/supervisord -c /etc/supervisor/supervisord.conf